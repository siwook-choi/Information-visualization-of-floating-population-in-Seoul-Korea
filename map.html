<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta charset="utf-8">
	<title>D3 Test</title>
	<script type="text/javascript" src="./lib/d3.js"></script>
	<script src="./lib/d3.js" charset="utf-8"></script>
	<script src="./lib/topojson.js" charsdet="utf-8"></script>
	<script src='./code.json' charsdet="utf-8"></script>
	<script src='./food_data.json' charsdet="utf-8"></script>
	<script src="./lib/distribute/nouislider.min.js"></script>
	<link rel="stylesheet" href="./lib/distribute/nouislider.min.css">
	<style>
		div.tooltip {	
			  position: absolute;			
			  text-align: center;			
			  width: 160px;					
			  height: 60px;					
			  padding: 2px;				
			  font: 12px sans-serif;		
			  background: lightsteelblue;	
			  border: 0px;		
			  border-radius: 8px;			
			  pointer-events: none;			
		  }
		  .wrapper{
			  display: grid;
			  grid-template-columns: 500px 200px;
			  grid-template-rows: 400px 400px;
		  }
	</style>
</head>

<body>
	<div class="wrapper">
		<div id='div1'></div>
		<div id='div2'>
			<p id="sliderDate_value"></p>
			<p id="sliderDate"></p>
			<p id="sliderTime_value"></p>
			<p id="sliderTime"></p>
			<p id="sliderAge_value"></p>
			<p id="sliderAge"></p>
			<p>性別</p>
			<p class="gender-select" style="width:200px;">
				<select id="selectGender">
					<option value="1" selected="selected">Total</option>
					<option value="2">Men</option>
					<option value="3">Women</option>
				</select>
			</p>
		</div>
		<div id='div3'></div>
		<div id='div4'>
			<p>検索品目</p>
			<p class="restaurant-select" style="width:200px;">
				<select id="selectRestaurantType">
					<option value="1" selected="selected">韓国料理</option>
					<option value="2">洋食</option>
					<option value="3">アジア料理</option>
					<option value="4">和食</option>
					<option value="5">中国料理</option>
					<option value="6">屋台料理</option>
					<option value="7">カフェ</option>
					<option value="8">バイキング</option>
					<option value="9">etc</option>
					<option value="10">billiard</option>
				</select>
			</p>
		</div>
	</div>

	<script type="text/javascript">
		const MIN_CITY_AREA = 1.0;
		var width = 600;
		var height = 400;
		var svg1 = d3.select("#div1").append("svg").attr("width", width).attr("height", height);
		var svg2 = d3.select("#div3").append("svg").attr("width", width).attr("height", height);
		var div1 = d3.select("#div1").append("div")
			.attr("class", "tooltip")
			.style("opacity", 0);
		var div2 = d3.select("#div3").append("div")
			.attr("class", "tooltip")
			.style("opacity", 0);


		init();

		async function init() {
			var cityDataHash = {}, popDataHash = {}, foodDataHash = {}, switchCodeHash = {}, cityList = [];
			var init_err = await initData(cityDataHash, popDataHash, foodDataHash, switchCodeHash, cityList);
			if (init_err) {
				console.log(init_err);
				return;
			}

			var sliderDate = document.getElementById('sliderDate');
			var sliderTime = document.getElementById('sliderTime');
			var sliderAge = document.getElementById('sliderAge');
			var selectGender = document.getElementById('selectGender');
			var selectRestaurantType = document.getElementById('selectRestaurantType');

			var seoul_dong_data = await d3.json("./lib/seoul_submunicipalities_topo_simple.topojson");
			var seoul_dong = topojson.feature(seoul_dong_data, seoul_dong_data.objects.seoul_submunicipalities_geo);
			var projection_dong = d3.geoMercator().center([127.05, 37.56]).translate([width / 2, height / 2]).scale(60000);
			var path_dong = d3.geoPath().projection(projection_dong);

			var seoul_gu_data = await d3.json("./lib/seoul_municipalities_topo_simple.topojson");
			var seoul_gu = topojson.feature(seoul_gu_data, seoul_gu_data.objects.seoul_municipalities_geo);
			var projection_gu = d3.geoMercator().center([127.05, 37.56]).translate([width / 2, height / 2]).scale(60000);
			var path_gu = d3.geoPath().projection(projection_gu);
			

			var KorEngHash = {};
			var gu_data = await d3.json("./gu_data.json");
			KorEngHash["서울"] = "Seoul";
			for (gu of gu_data){
				KorEngHash[gu["SIG_KOR_NM"]] = gu["SIG_ENG_NM"];
			}

			for (dong of seoul_dong.features){
				KorEngHash[dong.properties.name] = dong.properties.name_eng;
			}
			
			function changeKorEng(name){
				var name_eng = "";
				var name_split = name.split(" ");
				name_eng += KorEngHash[name_split[0]] + " "
					+ KorEngHash[name_split[1]] + "<br>"
					+ KorEngHash[name_split[2]];
				return name_eng;
			}


			var billiard_hash = {};
			await initBilliard(billiard_hash);

			var slider_date = 20181020;
			var slider_time = 14;
			var slider_age_lower, slider_age_upper;
			var select_box_gender = "total";
			var select_box_food = 4;
			noUiSlider.create(sliderDate, {
				start: 12,
				connect: false,
				step: 1,
				range: {
					'min': 1,
					'max': 24
				}
			});

			noUiSlider.create(sliderTime, {
				start: 12,
				connect: false,
				step: 1,
				range: {
					'min': 0,
					'max': 23
				}
			});

			noUiSlider.create(sliderAge, {
				start: [20, 40],
				connect: true,
				step: 5,
				margin: 5,
				range: {
					'min': 0,
					'max': 75
				}
			});

			sliderDate.noUiSlider.on('update', function (value, handle) {
				var date = parseInt(value);

				document.getElementById('sliderDate_value').innerHTML =
					"date: 2018年10月" + date + "日";
				if (date < 10) {
					slider_date = "2018100" + date;
				}
				else {
					slider_date = "201810" + date;
				}

				refreshSvg1();
			});

			sliderTime.noUiSlider.on('update', function (value, handle) {
				var time = parseInt(value);
				document.getElementById('sliderTime_value').innerHTML =
					"time: " + time + "時";
				if (time < 10) {
					slider_time = "0" + time;
				}
				else {
					slider_time = "" + time;
				}
				refreshSvg1();
			});

			sliderAge.noUiSlider.on('update', function (values, handle) {
				slider_age_lower = parseInt(values[0]);
				slider_age_upper = parseInt(values[1]);
				if (slider_age_lower == 5) {
					slider_age_lower = 0;
				}
				if(slider_age_upper == 75){
                    document.getElementById('sliderAge_value').innerHTML =
                        "age: " + slider_age_lower + " ～ " + "歳";
                }
                else{
                    document.getElementById('sliderAge_value').innerHTML =
                        "age: " + slider_age_lower + " ～ " + (slider_age_upper - 1) + "歳";
                }
				refreshSvg1();
			});
			selectGender.onchange = () => {
				var gender = parseInt(selectGender.value);
				switch (gender) {
					case 1: select_box_gender = "total"; break;
					case 2: select_box_gender = "man"; break;
					case 3: select_box_gender = "woman"; break;
				}
				refreshSvg1();
			};
			selectRestaurantType.onchange = () => {
				var restaurant = parseInt(selectRestaurantType.value);
				select_box_food = restaurant;
				refreshSvg2();
			};


			initSvg1();
			initSvg2();
			function initSvg1() {
				var color = getScaleLinearSvg1();
				svg1.selectAll("path").data(seoul_dong.features).enter().append("path").attr("d", path_dong)
					.attr("stroke", "#333333").attr("stroke-width", 0.5)
					.attr("fill", function (d) {
						var code = switchCodeHash[d.properties.code];
						var pop = fetchPopData(code, slider_date, slider_time, slider_age_lower, slider_age_upper, select_box_gender)
							/ cityDataHash[code].area;
						return "rgb(255," +
							Math.floor(color(pop)) +
							"," + Math.floor(color(pop)) +
							")";
					})
					.on("mouseover", function (d) {
						var code = switchCodeHash[d.properties.code];
						div1.transition()
							.duration(100)
							.style("opacity", .9);
						div1.html(changeKorEng(cityDataHash[code].name) + "<br>人口密度(人/km^2):<br>"
							+ (fetchPopData(code, slider_date, slider_time, slider_age_lower, slider_age_upper, select_box_gender)
								/ cityDataHash[code].area).toFixed(2))
							.style("left", (d3.event.pageX) + "px")
							.style("top", (d3.event.pageY - 28) + "px");
					})
					.on("mouseout", function (d) {
						div1.transition()
							.duration(200)
							.style("opacity", 0);
					});
			}
			function refreshSvg1() {
				var color = getScaleLinearSvg1();
				svg1.selectAll("path").attr("fill", function (d) {
					var code = switchCodeHash[d.properties.code];
					var pop = fetchPopData(code, slider_date, slider_time, slider_age_lower, slider_age_upper, select_box_gender)
						/ cityDataHash[code].area;
					return "rgb(255," +
						Math.floor(color(pop)) +
						"," + Math.floor(color(pop)) +
						")";
				});
			}
			function getScaleLinearSvg1() {
				var max = 0.0, min = 999999.0;
				for (code of cityList) {
					var popDensity = fetchPopData(code, slider_date, slider_time, slider_age_lower, slider_age_upper, select_box_gender)
						/ cityDataHash[code].area;
					if (popDensity > max) {
						max = popDensity;
					}
					if (popDensity < min) {
						min = popDensity;
					}
				}
				return d3.scaleLinear().domain([min, max]).range([255, 0]);
			}

			function fetchPopData(code, date, time, age_lower, age_upper, gender) {
				var sum = 0.0;
				for (var age = age_lower; age < age_upper; age += 5) {
					var currentHash = popDataHash[code][date][time];
					var ageString;
					if (age >= 10 && age < 70) {
						ageString = "_" + age + "_" + (age + 4);
					}
					if (age < 10) {
						ageString = "_0_9";
						age = 5;
					}
					if (age >= 70) {
						ageString = "_70_over";
					}
					if (gender == "total") {
						sum += parseFloat(currentHash["pop_" + "man" + ageString]);
						sum += parseFloat(currentHash["pop_" + "woman" + ageString]);
					}
					else {
						sum += parseFloat(currentHash[("pop_" + gender + ageString)]);
					}
				}
				return sum;
			}

			function initSvg2() {
				var color = getScaleLinearSvg2();

				svg2.selectAll("path").data(seoul_dong.features).enter().append("path").attr("d", path_dong)
					.attr("stroke", "#333333").attr("stroke-width", 0.5)
					.attr("fill", function (d) {
						var code = switchCodeHash[d.properties.code];
						var food = fetchFoodData(code, select_box_food);
						food /= getArea(code);
						return "rgb(255," +
							Math.floor(color(food)) +
							"," + Math.floor(color(food)) +
							")";
					})
					.on("mouseover", function (d) {
						var code = switchCodeHash[d.properties.code];
						var food = fetchFoodData(code, select_box_food);
						food /= getArea(code);
						div2.transition()
							.duration(100)
							.style("opacity", .9);
						div2.html(changeKorEng(cityDataHash[code].name) + "<br>飲食店の密度(店/km^2): "
							+ (food).toFixed(2))
							.style("left", (d3.event.pageX) + "px")
							.style("top", (d3.event.pageY - 28) + "px");
					})
					.on("mouseout", function (d) {
						div2.transition()
							.duration(200)
							.style("opacity", 0);
					});
			}

			function refreshSvg2() {
				var color = getScaleLinearSvg2();
				svg2.selectAll("path").attr("fill", function (d) {
					var code = switchCodeHash[d.properties.code];
					var food = fetchFoodData(code, select_box_food);
					food /= getArea(code);
					return "rgb(255," +
						Math.floor(color(food)) +
						"," + Math.floor(color(food)) +
						")";
				});
			}

			function getScaleLinearSvg2() {
				var max = 0.0, min = 999999.0;
				for (code of cityList) {
					var food = fetchFoodData(code, select_box_food);
					food /= getArea(code);
					if (food > max) {
						max = food;
					}
					if (food < min) {
						min = food;
					}
				}
				return d3.scaleLinear().domain([min, max]).range([255, 0]);
			}
			function getArea(code) {
				if (cityDataHash[code].area < MIN_CITY_AREA) {
					return MIN_CITY_AREA;
				}
				else {
					return cityDataHash[code].area;
				}
			}

			function fetchFoodData(code, select_box_food) {
				if (select_box_food < 10) {
					return foodDataHash[code]["menu_" + select_box_food]
				}
				else if (select_box_food == 10) {
					return billiard_hash[code];
				}
			}
		};

		async function initBilliard(billiard_hash) {
			var dong_data = await d3.csv("./KIKmix.csv");
			var dong_hash = {};
			for (dong of dong_data) {
				dong_hash[dong["DONG_OLD"]] = dong["H_DNG_CD"].substr(0, 8);
				billiard_hash[dong["H_DNG_CD"].substr(0, 8)] = 0;
			}
			var billiard_data = await d3.json("./billiard_data.json");
			for (billiard of billiard_data["DATA"]) {
				if (billiard["addr_old"] != null) {
					var addr = billiard["addr_old"].split(" ");
					if(billiard_hash[dong_hash[addr[2]]]==undefined || billiard_hash[dong_hash[addr[2]]]==null){
					}
					else{
						billiard_hash[dong_hash[addr[2]]]++;
					}
				}
			}
		}
		async function initData(cityDataHash, popDataHash, foodDataHash, switchCodeHash, cityList) {
			try {
				cityAreaHash = {};
				var areaData = await d3.tsv("./area.tsv");
				for (d of areaData) {
					cityAreaHash[[d.CT_NM + " " + d.H_DNG_NM]] = d.AREA;
				}
				var codeData = await d3.json("./code.json");
				for (d of codeData) {
					cityDataHash[d["H_DNG_CD"]] = {
						name: d["DO_NM"] + " " + d["CT_NM"] + " " + d["H_DNG_NM"],
						area: cityAreaHash[d["CT_NM"] + " " + d["H_DNG_NM"]]
					};
					cityList.push(d["H_DNG_CD"]);
					switchCodeHash[d["H_SDNG_CD"]] = d["H_DNG_CD"];
				}
				var popData = await d3.tsv("./pop_data.csv");
				for (d of popData) {
					if (popDataHash[d.code] == undefined) {
						popDataHash[d.code] = {};
					}
					if (popDataHash[d.code][d.date] == undefined) {
						popDataHash[d.code][d.date] = {};
					}
					popDataHash[d.code][d.date][d.time] = {
						pop_total: d.pop_total,
						pop_man_0_9: d.pop_man_0_9, pop_man_10_14: d.pop_man_10_14,
						pop_man_15_19: d.pop_man_15_19, pop_man_20_24: d.pop_man_20_24,
						pop_man_25_29: d.pop_man_25_29, pop_man_30_34: d.pop_man_30_34,
						pop_man_35_39: d.pop_man_35_39, pop_man_40_44: d.pop_man_40_44,
						pop_man_45_49: d.pop_man_45_49, pop_man_50_54: d.pop_man_50_54,
						pop_man_55_59: d.pop_man_55_59, pop_man_60_64: d.pop_man_60_64,
						pop_man_65_69: d.pop_man_65_69, pop_man_70_over: d.pop_man_70_over,
						pop_woman_0_9: d.pop_woman_0_9, pop_woman_10_14: d.pop_woman_10_14,
						pop_woman_15_19: d.pop_woman_15_19, pop_woman_20_24: d.pop_woman_20_24,
						pop_woman_25_29: d.pop_woman_25_29, pop_woman_30_34: d.pop_woman_30_34,
						pop_woman_35_39: d.pop_woman_35_39, pop_woman_40_44: d.pop_woman_40_44,
						pop_woman_45_49: d.pop_woman_45_49, pop_woman_50_54: d.pop_woman_50_54,
						pop_woman_55_59: d.pop_woman_55_59, pop_woman_60_64: d.pop_woman_60_64,
						pop_woman_65_69: d.pop_woman_65_69, pop_woman_70_over: d.pop_woman_70_over
					};
				}
				var foodData = await d3.json("./food_data.json");
				for (d of foodData) {
					foodDataHash[d.id] = d;
				}
			} catch (e) {
				return e;
			}
			return false;
		}

	</script>
</body>

</html>