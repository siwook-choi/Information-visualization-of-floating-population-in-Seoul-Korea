<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta charset="utf-8">
	<title>D3 Test</title>
	<script type="text/javascript" src="./lib/d3.js"></script>
	<script src="./lib/d3.js" charset="utf-8"></script>
	<script src="./lib/topojson.js" charsdet="utf-8"></script>
	<script src='./code.json' charsdet="utf-8"></script>
	<script src='./food_data.json' charsdet="utf-8"></script>
</head>

<body>
	<script type="text/javascript">
		var width = 960;
		var height = 500;
		var svg = d3.select("body").append("svg").attr("width", width).attr("height", height);
		var color = d3.scaleLinear().domain([4000, 50000]).range([255, 0]);

		var cityNameHash = {}, popTotalHash = {}, foodDataHash = {}, switchCodeHash = {};
		initData(cityNameHash, popTotalHash, foodDataHash, switchCodeHash).then((err) => {
			if (err) {
				console.log(err);
				return;
			}
			console.log(cityNameHash);
			console.log(popTotalHash);
			console.log(foodDataHash);
			console.log(switchCodeHash);



			d3.json("./lib/seoul_submunicipalities_topo_simple.topojson").then(function (data) {

				var seoul = topojson.feature(data, data.objects.seoul_submunicipalities_geo);
				var projection = d3.geoMercator().center([126.9895, 37.5551]).translate([width / 2, height / 2]).scale(70000);
				var path = d3.geoPath().projection(projection);
				svg.selectAll("path").data(seoul.features).enter().append("path").attr("d", path).attr("fill", function (d) {
					if(Math.floor(color(popTotalHash[switchCodeHash[d.properties.code]]))==NaN){
						console.log(d.properties);
					}
					var a = "rgb(255," + Math.floor(color(popTotalHash[switchCodeHash[d.properties.code]])) + "," + Math.floor(color(popTotalHash[switchCodeHash[d.properties.code]])) + ")";
					if(a=="rgb(255,NaN,NaN)"){
						console.log(d.properties);
						console.log(switchCodeHash[d.properties.code]);
					}
					return a;
				}).attr("stroke", "#333333").attr("stroke-width", 0.5);

			});
		});

		async function initData(cityNameHash, popTotalHash, foodDataHash, switchCodeHash) {
			try {

				var codeData = await d3.json("./code.json");
				for (d of codeData) {
					cityNameHash[d["H_DNG_CD"]] = d["DO_NM"] + d["CT_NM"] + d["H_DNG_NM"];
					switchCodeHash[d["H_SDNG_CD"]] = d["H_DNG_CD"];
				}

				var popData = await d3.tsv("./pop_data.csv");
				for (d of popData) {
					popTotalHash[d.code] = d.pop_total;
				}

				var foodData = await d3.json("./food_data.json");
				for (d of foodData) {
					foodDataHash[d.id] = d;
				}
			} catch (e) {
				return e;
			}

			return false;
		}
	</script>
</body>

</html>