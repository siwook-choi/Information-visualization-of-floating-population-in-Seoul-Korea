<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta charset="utf-8">
	<title>D3 Test</title>
	<script type="text/javascript" src="./lib/d3.js"></script>
	<script src="./lib/d3.js" charset="utf-8"></script>
	<script src="./lib/topojson.js" charsdet="utf-8"></script>
	<script src='./code.json' charsdet="utf-8"></script>
	<script src='./food_data.json' charsdet="utf-8"></script>
	<script src="./lib/distribute/nouislider.min.js"></script>
	<link rel="stylesheet" href="./lib/distribute/nouislider.min.css">
	<style>
		div.tooltip {	
			  position: absolute;			
			  text-align: center;			
			  width: 165px;					
			  height: 60px;					
			  padding: 2px;				
			  font: 12px sans-serif;		
			  background: lightsteelblue;	
			  border: 0px;		
			  border-radius: 8px;			
			  pointer-events: none;			
		  }
		  
	</style>
</head>

<body>
	<p id="slider"></p>
	<script type="text/javascript">
		var width = 960;
		var height = 500;
		var svg = d3.select("body").append("svg").attr("width", width).attr("height", height);
		var div = d3.select("body").append("div")
        	.attr("class", "tooltip")
        	.style("opacity", 0);
		var color = d3.scaleLinear().domain([4000, 30000]).range([255, 0]);
		var cityDataHash = {}, popDataHash = {}, foodDataHash = {}, switchCodeHash = {}, cityList = [];
		initData(cityDataHash, popDataHash, foodDataHash, switchCodeHash, cityList).then((err) => {
			if (err) {
				console.log(err);
				return;
			}
			var slider = document.getElementById('slider');

			d3.json("./lib/seoul_submunicipalities_topo_simple.topojson").then(function (data) {
				var seoul = topojson.feature(data, data.objects.seoul_submunicipalities_geo);
				var projection = d3.geoMercator().center([126.9895, 37.5551]).translate([width / 2, height / 2]).scale(70000);
				var path = d3.geoPath().projection(projection);
				var slider_date = 20181020;
				var slider_time = 14;
				var slider_age_lower, slider_age_upper;
				var select_box_gender = "man";

				noUiSlider.create(slider, {
					start: [20, 40],
					connect: true,
					step: 5,
					margin: 5,
					range: {
						'min': 0,
						'max': 75
					}
				});
				slider.noUiSlider.on('update', function (values, handle) {
					slider_age_upper = parseInt(values[1]);
					slider_age_lower = parseInt(values[0]);
					var max = 0.0, min = 999999.0;
					for (city of cityList) {
						var popDensity = fetchData(city, slider_date, slider_time, slider_age_lower, slider_age_upper, select_box_gender)
							/ cityDataHash[city].area;
						if (popDensity > max) {
							max = popDensity;
						}
						if (popDensity < min) {
							min = popDensity;
						}
					}
					var color = d3.scaleLinear().domain([min, max]).range([255, 0]);

					svg.selectAll("path").attr("fill", function (d) {
						var code = switchCodeHash[d.properties.code];
						var pop = fetchData(code, slider_date, slider_time, slider_age_lower, slider_age_upper, select_box_gender)
							/ cityDataHash[code].area;
						return "rgb(255," +
							Math.floor(color(pop)) +
							"," + Math.floor(color(pop)) +
							")";
					});
				});

				var max = 0.0, min = 999999.0;
				for (city of cityList) {
					var popDensity = fetchData(city, slider_date, slider_time, slider_age_lower, slider_age_upper, select_box_gender)
						/ cityDataHash[city].area;
					if (popDensity > max) {
						max = popDensity;
					}
					if (popDensity < min) {
						min = popDensity;
					}
				}
				var color = d3.scaleLinear().domain([min, max]).range([255, 0]);

				svg.selectAll("path").data(seoul.features).enter().append("path").attr("d", path)
					.attr("stroke", "#333333").attr("stroke-width", 0.5)
					.attr("fill", function (d) {
						var code = switchCodeHash[d.properties.code];
						var pop = fetchData(code, slider_date, slider_time, slider_age_lower, slider_age_upper, select_box_gender)
							/ cityDataHash[code].area;
						return "rgb(255," +
							Math.floor(color(pop)) +
							"," + Math.floor(color(pop)) +
							")";
					})
					.on("mouseover", function (d) {
						var code = switchCodeHash[d.properties.code];
						div.transition()
							.duration(200)
							.style("opacity", .9);
						div.html(cityDataHash[code].name + "<br>人口密度(人/km^2): "
							+ (fetchData(code, slider_date, slider_time, slider_age_lower, slider_age_upper, select_box_gender)
							/ cityDataHash[code].area).toFixed(2))
							.style("left", (d3.event.pageX) + "px")
							.style("top", (d3.event.pageY - 28) + "px");
					})
					.on("mouseout", function (d) {
						div.transition()
							.duration(500)
							.style("opacity", 0);
					});
			});
		});




		async function initData(cityDataHash, popDataHash, foodDataHash, switchCodeHash, cityList) {
			try {
				cityAreaHash = {};
				var areaData = await d3.tsv("./area.tsv");
				for (d of areaData) {
					cityAreaHash[[d.CT_NM + " " + d.H_DNG_NM]] = d.AREA;
				}
				var codeData = await d3.json("./code.json");
				for (d of codeData) {
					cityDataHash[d["H_DNG_CD"]] = {
						name: d["DO_NM"] + " " + d["CT_NM"] + " " + d["H_DNG_NM"],
						area: cityAreaHash[d["CT_NM"] + " " + d["H_DNG_NM"]]
					};
					cityList.push(d["H_DNG_CD"]);
					switchCodeHash[d["H_SDNG_CD"]] = d["H_DNG_CD"];
				}
				var popData = await d3.tsv("./pop_data.csv");
				for (d of popData) {
					if (popDataHash[d.code] == undefined) {
						popDataHash[d.code] = {};
					}
					if (popDataHash[d.code][d.date] == undefined) {
						popDataHash[d.code][d.date] = {};
					}
					popDataHash[d.code][d.date][d.time] = { pop_total: d.pop_total, pop_man_0_9: d.pop_man_0_9, pop_man_10_14: d.pop_man_10_14, pop_man_15_19: d.pop_man_15_19, pop_man_20_24: d.pop_man_20_24, pop_man_25_29: d.pop_man_25_29, pop_man_30_34: d.pop_man_30_34, pop_man_35_39: d.pop_man_35_39, pop_man_40_44: d.pop_man_40_44, pop_man_45_49: d.pop_man_45_49, pop_man_50_54: d.pop_man_50_54, pop_man_55_59: d.pop_man_55_59, pop_man_60_64: d.pop_man_60_64, pop_man_65_69: d.pop_man_65_69, pop_man_70_over: d.pop_man_70_over, pop_woman_0_9: d.pop_woman_0_9, pop_woman_10_14: d.pop_woman_10_14, pop_woman_15_19: d.pop_woman_15_19, pop_woman_20_24: d.pop_woman_20_24, pop_woman_25_29: d.pop_woman_25_29, pop_woman_30_34: d.pop_woman_30_34, pop_woman_35_39: d.pop_woman_35_39, pop_woman_40_44: d.pop_woman_40_44, pop_woman_45_49: d.pop_woman_45_49, pop_woman_50_54: d.pop_woman_50_54, pop_woman_55_59: d.pop_woman_55_59, pop_woman_60_64: d.pop_woman_60_64, pop_woman_65_69: d.pop_woman_65_69, pop_woman_70_over: d.pop_woman_70_over };
				}
				var foodData = await d3.json("./food_data.json");
				for (d of foodData) {
					foodDataHash[d.id] = d;
				}
			} catch (e) {
				return e;
			}
			return false;
		}
		function fetchData(code, date, time, age_lower, age_upper, gender) {
			var sum = 0.0;
			for (var age = age_lower; age < age_upper; age += 5) {
				var currentHash = popDataHash[code][date][time];
				var ageString;
				if (age >= 10 && age < 70) {
					ageString = "_" + age + "_" + (age + 4);
				}
				if (age < 10) {
					ageString = "_0_9";
					age = 5;
				}
				if (age >= 70) {
					ageString = "_70_over";
				}
				if(gender == "total"){
					sum += parseFloat(currentHash["pop_" + "man" + ageString]);
					sum += parseFloat(currentHash["pop_" + "woman" + ageString]);
				}
				else{
					sum += parseFloat(currentHash[("pop_" + gender + ageString)]);
				}
			}
			return sum;
		}
	</script>
</body>

</html>