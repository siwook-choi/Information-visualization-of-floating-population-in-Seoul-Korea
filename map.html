<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta charset="utf-8">
	<title>D3 Test</title>
	<script type="text/javascript" src="./lib/d3.js"></script>
	<script src="./lib/d3.js" charset="utf-8"></script>
	<script src="./lib/topojson.js" charsdet="utf-8"></script>
	<script src='./code.json' charsdet="utf-8"></script>
	<script src='./food_data.json' charsdet="utf-8"></script>
	<script src="./lib/distribute/nouislider.min.js"></script>
    <link rel="stylesheet" href="./distribute/nouislider.min.css">
</head>

<body>
	<script type="text/javascript">
		var width = 960;
		var height = 500;
		var svg = d3.select("body").append("svg").attr("width", width).attr("height", height);
		var color = d3.scaleLinear().domain([4000, 30000]).range([255, 0]);

		var cityDataHash = {}, popTotalHash = [], foodDataHash = {}, switchCodeHash = {};
		initData(cityDataHash, popTotalHash, foodDataHash, switchCodeHash).then((err) => {
			if (err) {
				console.log(err);
				return;
			}
			console.log(cityDataHash);
			console.log( popTotalHash);
			console.log(foodDataHash);
			console.log(switchCodeHash);



			d3.json("./lib/seoul_submunicipalities_topo_simple.topojson").then(function (data) {

				var seoul = topojson.feature(data, data.objects.seoul_submunicipalities_geo);
				var projection = d3.geoMercator().center([126.9895, 37.5551]).translate([width / 2, height / 2]).scale(70000);
				var path = d3.geoPath().projection(projection);
				svg.selectAll("path").data(seoul.features).enter().append("path").attr("d", path).attr("fill", function (d) {
					if(Math.floor(color(popTotalHash[20181024][23][switchCodeHash[d.properties.code]].pop_total))==NaN){
						console.log(d.properties);
					}
					var a = "rgb(255," + Math.floor(color(popTotalHash[switchCodeHash[d.properties.code]].pop_total
						/cityDataHash[switchCodeHash[d.properties.code]].area)) + "," +
						 Math.floor(color(popTotalHash[switchCodeHash[d.properties.code]].pop_total / cityDataHash[switchCodeHash[d.properties.code]].area)) + ")";
					if(a=="rgb(255,NaN,NaN)"){
						console.log(d.properties);
						console.log(switchCodeHash[d.properties.code]);
					}
					return a;
				}).attr("stroke", "#333333").attr("stroke-width", 0.5);

			});
		});

		async function initData(cityDataHash, popTotalHash, foodDataHash, switchCodeHash) {
			try {
				cityAreaHash = {};
				var areaData = await d3.tsv("./area.tsv");
				for (d of areaData){
					cityAreaHash[[d.CT_NM + d.H_DNG_NM]] = d.AREA;
				}

				var codeData = await d3.json("./code.json");
				for (d of codeData) {
					cityDataHash[d["H_DNG_CD"]] = {name:d["DO_NM"] + d["CT_NM"] + d["H_DNG_NM"],
						area:cityAreaHash[d["CT_NM"] + d["H_DNG_NM"]]};
					switchCodeHash[d["H_SDNG_CD"]] = d["H_DNG_CD"];
				}

				var popData = await d3.tsv("./pop_data.csv");
				for (d of popData) {
<<<<<<< HEAD
						popTotalHash[d.code] = {date:d.date,time:d.time,pop_total:d.pop_total,pop_man_0_9:d.pop_man_0_9,pop_man_10_14:d.pop_man_10_14,pop_man_15_19:d.pop_man_15_19,pop_man_20_24:d.pop_man_20_24,pop_man_25_29:d.pop_man_25_29,pop_man_30_34:d.pop_man_30_34,pop_man_35_39:d.pop_man_35_39,pop_man_40_44:d.pop_man_40_44,pop_man_45_49:d.pop_man_45_49,pop_man_50_54:d.pop_man_50_54,pop_man_55_59:d.pop_man_55_59,pop_man_60_64:d.pop_man_60_64,pop_man_65_69:d.pop_man_65_69,pop_man_70_over:d.pop_man_70_over,pop_woman_0_9:d.pop_woman_0_9,pop_woman_10_14:d.pop_woman_10_14,pop_woman_15_19:d.pop_woman_15_19,pop_woman_20_24:d.pop_woman_20_24,pop_woman_25_29:d.pop_woman_25_29,pop_woman_30_34:d.pop_woman_30_34,pop_woman_35_39:d.pop_woman_35_39,pop_woman_40_44:d.pop_woman_40_44,pop_woman_45_49:d.pop_woman_45_49,pop_woman_50_54:d.pop_woman_50_54,pop_woman_55_59:d.pop_woman_55_59,pop_woman_60_64:d.pop_woman_60_64,pop_woman_65_69:d.pop_woman_65_69,pop_woman_70_over:d.pop_woman_70_over};		
=======
					popTotalHash[d.date] = {pop_total:d.pop_total,pop_man_0_9:d.pop_man_0_9,pop_man_10_14:d.pop_man_10_14,pop_man_15_19:d.pop_man_15_19,pop_man_20_24:d.pop_man_20_24,pop_man_25_29:d.pop_man_25_29,pop_man_30_34:d.pop_man_30_34,pop_man_35_39:d.pop_man_35_39,pop_man_40_44:d.pop_man_40_44,pop_man_45_49:d.pop_man_45_49,pop_man_50_54:d.pop_man_50_54,pop_man_55_59:d.pop_man_55_59,pop_man_60_64:d.pop_man_60_64,pop_man_65_69:d.pop_man_65_69,pop_man_70_over:d.pop_man_70_over,pop_woman_0_9:d.pop_woman_0_9,pop_woman_10_14:d.pop_woman_10_14,pop_woman_15_19:d.pop_woman_15_19,pop_woman_20_24:d.pop_woman_20_24,pop_woman_25_29:d.pop_woman_25_29,pop_woman_30_34:d.pop_woman_30_34,pop_woman_35_39:d.pop_woman_35_39,pop_woman_40_44:d.pop_woman_40_44,pop_woman_45_49:d.pop_woman_45_49,pop_woman_50_54:d.pop_woman_50_54,pop_woman_55_59:d.pop_woman_55_59,pop_woman_60_64:d.pop_woman_60_64,pop_woman_65_69:d.pop_woman_65_69,pop_woman_70_over:d.pop_woman_70_over};		
>>>>>>> 532ae6b8fbc2177f2a17fb7f268439e6ea5a6aa9
				}

				var foodData = await d3.json("./food_data.json");
				for (d of foodData) {
					foodDataHash[d.id] = d;
				}
			} catch (e) {
				return e;
			}

			return false;
		}
	</script>
</body>

</html>
